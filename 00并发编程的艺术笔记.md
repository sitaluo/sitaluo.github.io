# 并发编程的艺术

## 第一章  并发编程的挑战

## 第二章  java并发机制的底层实现原理

### 2.1 volatile的应用

#### 	volatile的定义：

​	java允许线程访问共享变量，为了确保共享变量能被准确和一致的更新，线程应该通过排他锁的方式单独获取这个变量。java提供volatile在某些情况下比锁更方便。**如果一个字段被声明为volatile,java内存模型确保所有线程看到的这个变量的值都是一致的。**（保存可见性但是不保证原子性）

#### volatile的原理：

​	volatile如何保证可见性呢？例如: `instance = new Singleton(); //instance 为volatile变量` ,其编译后对应的汇编是 `movb xxxxxxxxx.. lock add1 xxx;` 有volatile修饰的共享变量编译后会生成有lock前缀的指令，lock前缀指令在多核处理器会引发两件事情：

1）将当前处理器的缓存行的数据会写回系统内存

2）这个写内存的操作会使在其他cpu里缓存了该内存地址的数据无效

#### volatile的优化

​	jdk7的并发包新增了一个队列集合类LinkedTransferQueue,在使用volatile变量时使用追加到64字节的方式来优化出队入队的性能。在某些处理器的高速缓存行是64字节宽，一个64字节的变量刚好占据一个缓存行，这样在加锁的时候只锁定一个变量，如果不是64字节，一个缓存行可能缓存多个变量，那么在加锁的时候就会锁定多个变量，可以避免头节点尾节点加载到一个缓存行。

### 2.2 synchronized的实现原理和应用

synchronized实现同步的基础：java中每一个对象都可以作为锁。具体表现为一下三种形式：

- 普通同步方法：琐是当前实例对象
- 静态同步方法：琐是当前类的class对象
- 同步代码块：锁是synchronized括号里面的对象

#### 2.2.1 java对象头

synchronized锁是存在java对象头里的。如果对现象是数组类型，则虚拟机用3个字宽存储对象头；如果对象是非数组类型，则用2字宽存储对象头。在32位虚拟机中1字宽等于4个字节。

| 长度        | 内容                   | 说明                         |
| ----------- | ---------------------- | ---------------------------- |
| 32bit/64bit | Mark Word              | 存储对象的hashCode和锁信息等 |
| 32bit/64bit | Class Metadata Address | 存储到对象类型数据的执政     |
| 32bit/64bit | Array Length           | 数组长度（如果是数组的话）   |

#### 2.2.2 锁的升级与对比

在java se1.6中，锁有四种状态：无锁状态 -> 偏向锁状态 -> 轻量级锁状态 -> 重量级锁状态。锁可以升级不能降级，这种策略是为了提升获取锁和释放锁的效率。

|    锁    |                             优点                             |                   缺点                   |            适用场景            |
| :------: | :----------------------------------------------------------: | :--------------------------------------: | :----------------------------: |
|  偏向锁  | 加锁和解锁不需要额外的消耗，和直接使用非同步方法仅仅村咋爱纳秒级的差别 | 在线程竞争的时候会带来额外的锁撤销的小号 |  只有一个线程访问同步块的场景  |
| 轻量级锁 |             竞争线程不会阻塞，提高程序的相应速度             |       得不到锁的线程会自旋小号cpu        | 追求相应时间，同步块执行时间短 |
| 重量级锁 |                竞争线程不会自旋，不会小号cpu                 |          线程阻塞，相应时间缓慢          |  追求吞吐量，同步块执行时间长  |








































